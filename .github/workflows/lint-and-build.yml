name: Lint & build
on: [push]
jobs:
  lint:
    name: Code linting
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        node-version: [16.x]
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/pnpm-install

      - uses: actions/cache@v3
        id: restore-dependencies
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-dependencies-
            ${{ runner.os }}-

      - name: Run ESLint
        run: pnpm lint
          -o eslint-report.txt

      - uses: actions/upload-artifact@v3
        with:
          name: lint-test-report
          path: eslint-report.txt

  build:
    name: build
    runs-on: ubuntu-20.04
    needs: lint
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/pnpm-install

      - uses: actions/cache@v3
        id: restore-dependencies
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-dependencies-
            ${{ runner.os }}-

      - run: pnpm build

      # - uses: actions/cache@v3
      #   id: cache-build
      #   with:
      #     path: ./*
      #     key: ${{ github.sha }}-react-next
      # - uses: actions/cache@v3
      #   id: restore-build
      #   with:
      #     path: ./*
      #     key: ${{ github.sha }}-react-next
